name: Benchmark Job

on:
  workflow_dispatch:
    inputs:
      leakDetectionLevel:
        description: "Leak detection level"
        required: true
        default: "disabled"
        type: choice
        options:
          - disabled
          - simple
          - advanced
          - paranoid
      flushConsolidate:
        description: "Flush Consolidate"
        required: true
        default: true
        type: boolean
      disableFlowControl:
        description: "Disable Flow Control"
        required: true
        default: true
        type: boolean

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - name: Clean up
        id: clean_up
        env:
          GITHUB_TOKEN: ${{secrets.ACTIONS_PAT}}
        run: sudo rm -rf *

      - uses: actions/checkout@v2
        with:
          path: zio-http

      - uses: actions/checkout@v2
        with:
          repository: dream11/FrameworkBenchmarks
          path: FrameworkBenchMarks

      - id: result
        working-directory: FrameworkBenchMarks
        env:
          GITHUB_TOKEN: ${{secrets.ACTIONS_PAT}}
          LEAK_DETECTION_LEVEL: ${{ github.event.inputs.leakDetectionLevel }}
          FLUSH_CONSOLIDATE: ${{ github.event.inputs.flushConsolidate }}
          DISABLE_FLOW_CONTROL: ${{ github.event.inputs.disableFlowControl }}
        run: |
          COMMIT=$(git rev-parse HEAD)

          cp ./zio-http/examp le/src/main/scala/example/PlainTextBenchmarkServer.scala ./frameworks/Scala/zio-http/src/main/scala/Main.scala

          sed -i "s/---COMMIT_SHA---/https://github.com/girdharshubham/zio-http.git#${COMMIT}/g" frameworks/Scala/zio-http/build.sbt
          ./tfb  --test zio-http | tee result
          RESULT_REQUEST=$(echo $(grep -B 1 -A 17 "Concurrency: 256 for plaintext" result) | grep -oiE "requests/sec: [0-9]+.[0-9]+")
          RESULT_CONCURRENCY=$(echo $(grep -B 1 -A 17 "Concurrency: 256 for plaintext" result) | grep -oiE "concurrency: [0-9]+")
          echo ::set-output name=request_result::$(echo $RESULT_REQUEST)
          echo ::set-output name=concurrency_result::$(echo $RESULT_CONCURRENCY)
          echo ::set-output name=sha::$(echo $COMMIT)

      - uses: peter-evans/commit-comment@v1
        with:
          sha: ${{steps.result.outputs.sha}}
          body: |
            **ðŸš€ Performance Benchmark:**
            ${{steps.result.outputs.concurrency_result}}
            ${{steps.result.outputs.request_result}}
